name: CI/CD Flask App with Ansible + ngrok

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Dependencies (Ansible + Python)
        run: |
          sudo apt update
          sudo apt install -y ansible python3-pip unzip wget

      - name: Run Ansible Playbook
        run: ansible-playbook -i ansible/inventory.ini ansible/playbook.yml

      - name: Install ngrok
        run: |
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          ./ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Start ngrok Tunnel for Flask App
        run: |
          nohup ./ngrok http 8000 > /dev/null &
          sleep 5
          curl --silent http://127.0.0.1:4040/api/tunnels > tunnels.json
          echo "ðŸ”— Public Flask URL:"
          cat tunnels.json | grep -o 'https://[0-9a-z]*\.ngrok\.io'

