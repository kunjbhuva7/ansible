# 1

name: Flask CI/CD with Ansible + ngrok (1 Hour Live Version)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout your repository code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Install Ansible, Python, and required tools
      - name: Install Ansible and Dependencies
        run: |
          sudo apt update
          sudo apt install -y ansible python3-pip unzip wget net-tools curl

      # 3ï¸âƒ£ Run Ansible Playbook (to install Flask and deploy app)
      - name: Run Ansible Playbook
        run: ansible-playbook -i ansible/inventory.ini ansible/playbook.yml

      # 4ï¸âƒ£ Install ngrok and authenticate using your token
      - name: Install and Authenticate ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          echo "ğŸ” Setting up ngrok authentication..."
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip
          unzip -qq ngrok-stable-linux-amd64.zip
          ./ngrok config add-authtoken "$NGROK_AUTH_TOKEN"

      # 5ï¸âƒ£ Start Flask manually to make sure itâ€™s running before ngrok starts
      - name: Start Flask app (background)
        run: |
          echo "ğŸš€ Starting Flask on port 8000..."
          nohup python3 app/app.py > flask.log 2>&1 &
          sleep 5
          echo "âœ… Checking Flask port..."
          netstat -tlnp | grep 8000 || echo "âš ï¸ Flask port not open!"

      # 6ï¸âƒ£ Launch ngrok tunnel and keep it alive for 1 hour
      - name: Start ngrok tunnel
        run: |
          echo "ğŸš€ Launching ngrok tunnel on port 8000..."
          nohup ./ngrok http 8000 --log=stdout > ngrok.log 2>&1 &

          # Wait up to 20 seconds for ngrok API to respond
          for i in {1..20}; do
            if curl -fs http://127.0.0.1:4040/api/tunnels > tunnels.json 2>/dev/null; then
              break
            fi
            echo "â³ Waiting for ngrok to come up ($i/20)..."
            sleep 1
          done

          echo "ğŸ”— Fetching ngrok public URL..."
          cat tunnels.json | grep -o 'https://[0-9a-z-]*\.ngrok[-a-z]*\.app' || \
          cat tunnels.json | grep -o 'https://[0-9a-z-]*\.ngrok\.io' || \
          (echo "âŒ ngrok failed to start:" && cat ngrok.log && exit 1)

          echo ""
          echo "âœ… Deployment successful!"
          echo "ğŸŒ Flask App is LIVE for 1 hour!"
          echo ""
          echo "To keep it alive longer, edit sleep time below ğŸ‘‡"

          # Keep workflow running for 1 hour (3600 seconds)
          for t in {1..60}; do
            echo "ğŸ• Live for: $t minute(s)..."
            sleep 60
          done

          echo "âŒ› Workflow completed after 1 hour. Tunnel closed."

