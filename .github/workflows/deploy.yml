name: Flask CI/CD with Ansible + ngrok (Working Version)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Ansible and Dependencies
        run: |
          sudo apt update
          sudo apt install -y ansible python3-pip unzip wget

      - name: Run Ansible Playbook
        run: ansible-playbook -i ansible/inventory.ini ansible/playbook.yml

      - name: Install and Authenticate ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          echo "ðŸ” Setting up ngrok authentication..."
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          ./ngrok config add-authtoken $NGROK_AUTH_TOKEN
          mkdir -p ~/.ngrok2
          echo "authtoken: $NGROK_AUTH_TOKEN" > ~/.ngrok2/ngrok.yml

      - name: Start ngrok Tunnel for Flask (Port 8000)
        run: |
          echo "ðŸš€ Starting ngrok tunnel..."
          nohup ./ngrok http 8000 > ngrok.log 2>&1 &
          sleep 8
          echo "ðŸ”— Fetching public URL..."
          curl --silent http://127.0.0.1:4040/api/tunnels > tunnels.json || (cat ngrok.log && exit 1)
          cat tunnels.json | grep -o 'https://[0-9a-z]*\.ngrok\.io' || (cat ngrok.log && exit 1)

