name: Flask CI/CD with Ansible + ngrok (Final Fixed Version)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Install Ansible, Python, tools
      - name: Install Ansible and Dependencies
        run: |
          sudo apt update
          sudo apt install -y ansible python3-pip unzip wget net-tools curl

      # 3Ô∏è‚É£ Run Ansible Playbook (deploy Flask)
      - name: Run Ansible Playbook
        run: ansible-playbook -i ansible/inventory.ini ansible/playbook.yml

      # 4Ô∏è‚É£ Install + Authenticate ngrok
      - name: Install and Authenticate ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          echo "üîê Setting up ngrok authentication..."
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip
          unzip -qq ngrok-stable-linux-amd64.zip
          ./ngrok config add-authtoken "$NGROK_AUTH_TOKEN"

      # 5Ô∏è‚É£ Start Flask manually to make sure port is live
      - name: Start Flask app (background)
        run: |
          echo "üöÄ Starting Flask on port 8000..."
          nohup python3 app/app.py > flask.log 2>&1 &
          sleep 5
          echo "‚úÖ Checking Flask port..."
          netstat -tlnp | grep 8000 || echo "‚ö†Ô∏è Flask port not open!"

      # 6Ô∏è‚É£ Launch ngrok tunnel and print the public URL
      - name: Start ngrok tunnel
        run: |
          echo "üöÄ Launching ngrok tunnel on port 8000..."
          nohup ./ngrok http 8000 --log=stdout > ngrok.log 2>&1 &

          # wait until ngrok API appears
          for i in {1..25}; do
            if curl -fs http://127.0.0.1:4040/api/tunnels > tunnels.json 2>/dev/null; then
              break
            fi
            echo "‚è≥ Waiting for ngrok to come up ($i/25)..."
            sleep 1
          done

          echo "üîó Fetching ngrok public URL..."
          cat tunnels.json | grep -o 'https://[0-9a-z-]*\.ngrok[-a-z]*\.app' || \
          cat tunnels.json | grep -o 'https://[0-9a-z-]*\.ngrok\.io' || \
          (echo "‚ùå ngrok failed to start:" && cat ngrok.log && exit 1)

          echo "‚úÖ Deployment finished successfully!"

