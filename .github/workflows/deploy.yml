name: Flask CI/CD with Ansible + ngrok (Final Working Version)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Ansible and Dependencies
        run: |
          sudo apt update
          sudo apt install -y ansible python3-pip unzip wget net-tools

      - name: Run Ansible Playbook
        run: ansible-playbook -i ansible/inventory.ini ansible/playbook.yml

      - name: Install and Authenticate ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          echo "üîê Setting up ngrok authentication..."
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip
          unzip -qq ngrok-stable-linux-amd64.zip
          ./ngrok config add-authtoken "$NGROK_AUTH_TOKEN"
          mkdir -p ~/.ngrok2
          echo "authtoken: $NGROK_AUTH_TOKEN" > ~/.ngrok2/ngrok.yml

      - name: Start Flask app (background)
        run: |
          echo "üöÄ Starting Flask manually on port 8000"
          nohup python3 app/app.py > flask.log 2>&1 &
          sleep 5
          echo "‚úÖ Checking Flask port..."
          netstat -tlnp | grep 8000 || echo "‚ö†Ô∏è Flask port not open!"

      - name: Start ngrok tunnel
        run: |
          echo "üöÄ Launching ngrok tunnel on port 8000..."
          nohup ./ngrok http 8000 --log=stdout > ngrok.log 2>&1 &
          # wait up to 20 seconds for ngrok API
          for i in {1..20}; do
            if curl -fs http://127.0.0.1:4040/api/tunnels > tunnels.json 2>/dev/null; then
              break
            fi
            echo "‚è≥ Waiting for ngrok to come up ($i/20)..."
            sleep 1
          done
          echo "üîó Fetching ngrok public URL..."
          cat tunnels.json | grep -o 'https://[0-9a-z]*\.ngrok\.io' || (echo "‚ùå ngrok failed to start:" && cat ngrok.log && exit 1)

