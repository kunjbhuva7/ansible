---
- name: Deploy app on localhost
  hosts: local
  become: yes
  tasks:
    - name: Ensure Python3 and pip are installed
      apt:
        name: [python3, python3-pip]
        state: present
        update_cache: yes

    - name: Install Flask safely
      pip:
        name: flask
        state: latest
        executable: pip3
        extra_args: --ignore-installed --break-system-packages

    - name: Stop running app (if exists)
      shell: |
        pkill -f "python3 /home/runner/work/ansible/ansible/app/app.py" || true
      ignore_errors: yes

    - name: Run Flask app on port 8004
      shell: |
        nohup python3 /home/runner/work/ansible/ansible/app/app.py &
      args:
        chdir: /home/runner/work/ansible/ansible/app/

